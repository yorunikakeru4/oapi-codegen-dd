package codegen

import "time"

// Configuration defines code generation customizations.
// PackageName to generate the code under.
// CopyrightHeader is the header to add to the generated code. Use without //.
// SkipPrune indicates whether to skip pruning unused components on the generated code.
// Output specifies the output options for the generated code.
//
// Filter is the configuration for filtering the paths and operations to be parsed.
//
// AdditionalImports defines any additional Go imports to add to the generated code.
// ErrorMapping is the configuration for mapping the OpenAPI error responses to Go types.
//
//	The key is the spec error type name
//	and the value is the dotted json path to the string result.
//
// UserTemplates is the map of user-provided templates overriding the default ones.
// UserContext is the map of user-provided context values to be used in templates user overrides.
type Configuration struct {
	PackageName     string  `yaml:"package"`
	CopyrightHeader string  `yaml:"copyright-header"`
	SkipPrune       bool    `yaml:"skip-prune"`
	Output          *Output `yaml:"output"`

	Generate *GenerateOptions `yaml:"generate"`
	Filter   FilterConfig     `yaml:"filter,omitempty"`

	AdditionalImports []AdditionalImport `yaml:"additional-imports,omitempty"`
	ErrorMapping      map[string]string  `yaml:"error-mapping,omitempty"`
	Client            *Client            `yaml:"client,omitempty"`

	UserTemplates map[string]string `yaml:"user-templates,omitempty"`
	UserContext   map[string]any    `yaml:"user-context,omitempty"`
}

func (o Configuration) Merge(other Configuration) Configuration {
	def := NewDefaultConfiguration()

	if o.PackageName == "" && other.PackageName != "" {
		o.PackageName = other.PackageName
	}
	if o.CopyrightHeader == "" && other.CopyrightHeader != "" {
		o.CopyrightHeader = other.CopyrightHeader
	}

	if o.Output != nil {
		if o.Output.Directory == "" {
			o.Output.Directory = "."
		}
		if o.Output.UseSingleFile && o.Output.Filename == "" {
			o.Output.Filename = "gen.go"
		}
	} else {
		o.Output = other.Output
	}

	if o.Generate == nil {
		o.Generate = other.Generate
		if o.Generate == nil {
			o.Generate = &GenerateOptions{
				Client:                 def.Generate.Client,
				AlwaysPrefixEnumValues: def.Generate.AlwaysPrefixEnumValues,
				DefaultIntType:         def.Generate.DefaultIntType,
			}
		}
	}

	if o.Client == nil {
		o.Client = other.Client
	}
	if o.Client.Name == "" && other.Client.Name != "" {
		o.Client.Name = other.Client.Name
	}

	return o
}

type AdditionalImport struct {
	Alias   string `yaml:"alias,omitempty"`
	Package string `yaml:"package"`
}

// FilterConfig is the configuration for filtering the paths and operations to be parsed.
type FilterConfig struct {
	Include FilterParamsConfig `yaml:"include"`
	Exclude FilterParamsConfig `yaml:"exclude"`
}

// FilterParamsConfig is the configuration for filtering the paths to be parsed.
type FilterParamsConfig struct {
	Paths            []string            `yaml:"paths"`
	Tags             []string            `yaml:"tags"`
	OperationIDs     []string            `yaml:"operation-ids"`
	SchemaProperties map[string][]string `yaml:"schema-properties"`
	Extensions       []string            `yaml:"extensions"`
}

type GenerateOptions struct {
	// Client specifies whether to generate a client. Defaults to false.
	Client bool `yaml:"client"`

	// OmitDescription specifies whether to omit schema description from the spec in the generated code. Defaults to false.
	OmitDescription bool `yaml:"omit-description"`

	// DefaultIntType specifies the default integer type to use. Defaults to "int".
	DefaultIntType string `yaml:"default-int-type"`

	// AlwaysPrefixEnumValues specifies whether to always prefix enum values with the schema name. Defaults to true.
	AlwaysPrefixEnumValues bool `yaml:"always-prefix-enum-values"`
}

type Output struct {
	UseSingleFile bool   `yaml:"use-single-file"`
	Directory     string `yaml:"directory"`
	Filename      string `yaml:"filename"`
}

type Client struct {
	Name    string        `yaml:"name"`
	Timeout time.Duration `yaml:"timeout"`
}

// NewDefaultConfiguration creates a new default Configuration.
func NewDefaultConfiguration() Configuration {
	return Configuration{
		PackageName:     "gen",
		CopyrightHeader: "Code generated by oapi-codegen. DO NOT EDIT.",
		Generate: &GenerateOptions{
			DefaultIntType:         "int",
			AlwaysPrefixEnumValues: true,
		},
		Output: &Output{
			UseSingleFile: true,
		},
		Client: &Client{
			Name:    "Client",
			Timeout: 3 * time.Second,
		},
	}
}

type keyValue[K, V any] struct {
	key   K
	value V
}
